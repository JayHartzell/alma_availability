!function(a,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((a="undefined"!=typeof globalThis?globalThis:a||self).AlmaAvailability={})}(this,function(a){"use strict";class t{static buildQueryUrl(a,t,e){const r=new URLSearchParams({version:"1.2",operation:"searchRetrieve",recordSchema:"marcxml",query:`alma.mms_id=${e}`});return`${a.endsWith("/")?a.slice(0,-1):a}/view/sru/${t}?${r.toString()}`}static async fetchXml(a){try{const t=await fetch(a);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const e=await t.text(),r=(new DOMParser).parseFromString(e,"application/xml");if(r.getElementsByTagName("parsererror").length>0)throw new Error("Failed to parse XML response");return r}catch(t){if(t instanceof TypeError)throw new Error(`Network error: ${t.message}`);throw t}}}class e{static extractAvaFields(a){const t=[],e=a.querySelectorAll('datafield[tag="AVA"]');if(0===e.length)throw new Error("No AVA fields found in response");return e.forEach(a=>{const e=this.parseAvaField(a);t.push(e)}),t}static parseAvaField(a){const t={};return a.querySelectorAll("subfield").forEach(a=>{const e=a.getAttribute("code"),r=a.textContent.trim();switch(e){case"0":t.mmsId=r;break;case"8":t.itemId=r;break;case"a":t.institution=r;break;case"b":t.locationCode=r;break;case"c":t.locationName=r;break;case"e":t.status=r;break;case"f":t.totalItems=parseInt(r,10)||0;break;case"g":t.onLoan=parseInt(r,10)||0;break;case"j":t.simplifiedLocation=r;break;case"k":t.holdingCount=parseInt(r,10)||0;break;case"p":t.priority=parseInt(r,10)||0;break;case"q":t.library=r;break;case"v":t.notes=r}}),t}static filterByLocation(a,t){return a.filter(a=>a.simplifiedLocation===t||a.locationCode===t)}static calculateSummary(a){if(0===a.length)return{availableCount:0,unavailableCount:0,totalCount:0,locationName:null,status:"not_found",onLoan:0,hasData:!1};const t=a[0];let e=0,r=0;return a.forEach(a=>{const t=(a.totalItems||0)-(a.onLoan||0);e+=Math.max(0,t),r+=a.totalItems||0}),{availableCount:e,totalCount:r,locationName:t.locationName||t.simplifiedLocation,status:e>0?"available":"unavailable",hasData:!0}}}class r extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.state={loading:!1,error:null,data:null}}connectedCallback(){this.render(),this.fetch()}async fetch(){this.state.loading=!0,this.state.error=null,this.render();try{const a=this.getAttribute("base-url"),r=this.getAttribute("institution-code"),o=this.getAttribute("mms-id"),n=this.getAttribute("location-code");if(!a)throw new Error("Missing required attribute: base-url");if(!r)throw new Error("Missing required attribute: institution-code");if(!o)throw new Error("Missing required attribute: mms-id");if(!n)throw new Error("Missing required attribute: location-code");const l=t.buildQueryUrl(a,r,o),i=await t.fetchXml(l),s=e.extractAvaFields(i),c=e.filterByLocation(s,n),d=e.calculateSummary(c);this.state.data=d,this.state.loading=!1}catch(a){this.state.error=a.message,this.state.loading=!1}this.render()}render(){const a=this.getStyles();let t="";this.state.loading?t='<div class="loading">Loading...</div>':this.state.error?t=`<div class="error">${this.escapeHtml(this.state.error)}</div>`:this.state.data&&(t=this.renderData(this.state.data)),this.shadowRoot.innerHTML=`\n      <style>${a}</style>\n      <div class="container">\n        ${t}\n      </div>\n    `}renderData(a){if(!a.hasData)return'<div class="no-data">Location not found</div>';return`\n      <div class="availability ${"available"===a.status?"available":"unavailable"}">\n        <div class="location">${this.escapeHtml(a.locationName)}</div>\n        <div class="status">\n          <span class="available-count">${a.availableCount}</span>\n          <span class="separator">/</span>\n          <span class="total-count">${a.totalCount}</span>\n        </div>\n        <div class="status-text">${"available"===a.status?"Available":"Unavailable"}</div>\n      </div>\n    `}getStyles(){const a=getComputedStyle(this);return`\n      :host {\n        --alma-text-color: ${a.getPropertyValue("--alma-text-color").trim()||"#333"};\n        --alma-bg-color: ${a.getPropertyValue("--alma-bg-color").trim()||"#f9f9f9"};\n        --alma-border-color: ${a.getPropertyValue("--alma-border-color").trim()||"#ddd"};\n        --alma-available-color: ${a.getPropertyValue("--alma-available-color").trim()||"#28a745"};\n        --alma-unavailable-color: ${a.getPropertyValue("--alma-unavailable-color").trim()||"#dc3545"};\n        --alma-error-color: ${a.getPropertyValue("--alma-error-color").trim()||"#721c24"};\n        --alma-error-bg: ${a.getPropertyValue("--alma-error-bg").trim()||"#f8d7da"};\n      }\n\n      .container {\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n        color: var(--alma-text-color);\n      }\n\n      .loading, .error, .no-data {\n        padding: 12px 16px;\n        border-radius: 4px;\n        font-size: 14px;\n      }\n\n      .loading {\n        background-color: var(--alma-bg-color);\n        border: 1px solid var(--alma-border-color);\n      }\n\n      .error {\n        background-color: var(--alma-error-bg);\n        color: var(--alma-error-color);\n        border: 1px solid var(--alma-error-color);\n      }\n\n      .no-data {\n        background-color: var(--alma-bg-color);\n        border: 1px solid var(--alma-border-color);\n        text-align: center;\n      }\n\n      .availability {\n        padding: 12px 16px;\n        border-radius: 4px;\n        border: 1px solid var(--alma-border-color);\n        background-color: var(--alma-bg-color);\n      }\n\n      .availability.available {\n        background-color: var(--alma-bg-color);\n      }\n\n      .availability.unavailable {\n        background-color: var(--alma-bg-color);\n      }\n\n      .location {\n        font-weight: 600;\n        font-size: 14px;\n        margin-bottom: 8px;\n      }\n\n      .status {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        font-size: 18px;\n        font-weight: 600;\n        margin-bottom: 6px;\n      }\n\n      .available-count {\n        color: var(--alma-available-color);\n      }\n\n      .total-count {\n        color: var(--alma-text-color);\n      }\n\n      .separator {\n        color: var(--alma-text-color);\n        margin: 0 2px;\n      }\n\n      .label {\n        font-size: 12px;\n        color: var(--alma-text-color);\n        font-weight: normal;\n      }\n\n      .status-text {\n        font-size: 13px;\n        font-weight: 500;\n      }\n\n      .availability.available .status-text {\n        color: var(--alma-available-color);\n      }\n\n      .availability.unavailable .status-text {\n        color: var(--alma-unavailable-color);\n      }\n    `}escapeHtml(a){const t=document.createElement("div");return t.textContent=a,t.innerHTML}}customElements.define("alma-availability",r),a.AlmaAvailability=r,a.MarcxmlParser=e,a.SruClient=t,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
